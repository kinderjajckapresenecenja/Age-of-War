<!doctype html>
<html lang="sl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Age of War — Web Game (Detailed Visuals)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  /* --- Keyframes for Animations --- */
  @keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7); }
    70% { transform: scale(1.02); box-shadow: 0 0 10px 15px rgba(249, 115, 22, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); }
  }

  /* --- Root Variables & Base Styles --- */
  :root {
    --bg-start: #1e293b;
    --bg-end: #0f172a;
    --panel-bg: rgba(15, 23, 42, 0.6);
    --panel-border: rgba(125, 211, 252, 0.15);
    --accent-primary: #f97316;
    --accent-secondary: #38bdf8;
    --text-primary: #e2e8f0;
    --text-muted: #94a3b8;
    --success: #4ade80;
    --danger: #f43f5e;
    --font-main: 'Poppins', Inter, system-ui, Segoe UI, Roboto, Arial;
  }

  html, body { height: 100%; margin: 0; font-family: var(--font-main); }
  body {
    background: linear-gradient(180deg, var(--bg-start) 0%, var(--bg-end) 100%);
    color: var(--text-primary);
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow: hidden; /* Prevent scrollbars from layout shifts */
  }

  /* --- Layout & Panels --- */
  header {
    padding: 16px 24px;
    display: flex;
    gap: 16px;
    align-items: center;
    width: 100%;
    max-width: 1300px;
    border-bottom: 1px solid var(--panel-border);
  }

  h1 { margin: 0; font-size: 20px; font-weight: 700; color: var(--text-primary); }
  h1 > span { color: var(--accent-primary); }

  #gameWrap {
    display: flex;
    gap: 16px;
    width: 100%;
    max-width: 1300px;
    padding: 24px;
  }

  #leftUI, #rightUI, #canvasWrap {
    background: var(--panel-bg);
    padding: 16px;
    border-radius: 16px;
    border: 1px solid var(--panel-border);
    box-shadow: 0 8px 32px rgba(2, 6, 23, .5);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }
  
  #leftUI, #rightUI { width: 300px; }
  #canvasWrap { flex: 1; padding: 12px; display: flex; flex-direction: column; }
  canvas { background: linear-gradient(180deg, #1b2b3b, #0f1724); border-radius: 10px; width: 100%; height: 480px; }

  /* --- UI Components --- */
  .stat { display: flex; justify-content: space-between; margin: 8px 0; font-size: 15px; }
  .stat > div:first-child { color: var(--text-muted); }
  .stat > div:last-child { font-weight: 600; }
  .ageName { font-weight: 700; font-size: 16px; margin-bottom: 8px; }
  
  hr { border: none; border-top: 1px solid var(--panel-border); margin: 16px 0; }
  
  button {
    background: linear-gradient(145deg, #2c3e50, #1f2a36);
    border: 1px solid rgba(255, 255, 255, .1);
    padding: 8px 12px;
    border-radius: 8px;
    color: var(--text-primary);
    cursor: pointer;
    font-family: var(--font-main);
    font-weight: 600;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    border-color: rgba(255, 255, 255, .2);
  }
  button:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  button.small { padding: 6px 10px; font-size: 13px; font-weight: 400; }
  
  #upgradeAge {
    background: linear-gradient(145deg, var(--accent-primary), #d97706);
    width: 100%;
    color: white;
    font-size: 14px;
    border: none;
  }
  #upgradeAge:not(:disabled) { animation: pulse 2.5s infinite; }
  #upgradeAge:disabled {
    background: #52525b;
    cursor: not-allowed;
    animation: none;
    opacity: 0.6;
  }

  .progress { height: 12px; background: #051019; border-radius: 8px; overflow: hidden; border: 1px solid rgba(0,0,0,0.2); }
  .progress > i {
    display: block;
    height: 100%;
    background: linear-gradient(90deg, var(--success), var(--accent-secondary));
    transition: width 0.3s ease;
  }

  .special { display: flex; flex-direction: column; gap: 8px; }
  .special > div { display: flex; gap: 8px; align-items: center; }
  
  footer { color: var(--text-muted); padding: 8px 24px; font-size: 13px; text-align: center; }

  /* --- Overlay & Toast --- */
  #overlay {
    position: fixed; inset: 0; display: none; align-items: center;
    justify-content: center; background: rgba(2, 6, 23, 0.7); z-index: 60;
    backdrop-filter: blur(4px);
  }
  #overlay .box {
    background: var(--panel-bg); padding: 24px 30px; border-radius: 16px;
    border: 1px solid var(--panel-border); min-width: 320px; text-align: center;
    box-shadow: 0 8px 32px rgba(2, 6, 23, .5);
  }
  #overlay .box > div { font-size: 20px; font-weight: 600; margin-bottom: 16px; }
  #overlay button { margin-top: 12px; padding: 10px 20px; font-size: 16px; }

  #toast {
    position: fixed; top: 24px; left: 50%; transform: translateX(-50%);
    background: rgba(8, 12, 18, 0.9); color: var(--text-primary);
    padding: 10px 16px; border-radius: 10px; display: none; z-index: 70;
    font-size: 15px; border: 1px solid var(--panel-border);
    backdrop-filter: blur(5px);
  }
</style>
</head>
<body>
<header>
  <h1>Age of War — <span>Web Game</span></h1>
  <div style="margin-left:auto;color:var(--text-muted)">Prototip: pošlji enote, zgradi obrambo, napreduj skozi 5 obdobij.</div>
</header>
<div id="gameWrap">
  <div id="leftUI">
    <div class="stat"><div>Gold</div><div id="gold">0</div></div>
    <div class="stat"><div>XP</div><div id="xp">0 / 100</div></div>
    <div class="progress" title="XP"><i id="xpBar" style="width:0%"></i></div>

    <hr>
    
    <div>
        <div class="ageName">Trenutno obdobje: <span id="ageLabel">Kamena doba</span></div>
        <div class="stat"><div>Gold/sec</div><div id="goldRate">1</div></div>
    </div>

    <div style="margin-top:16px">
      <button id="upgradeAge">Napreduj v naslednje obdobje</button>
    </div>

    <hr>

    <div>
      <div style="font-weight:700;margin-bottom:12px;font-size:16px;">Posebni napadi</div>
      <div class="special">
        <div style="display:flex;gap:8px;align-items:center"><button id="sp1">Meteor (200g)</button><div style="font-size:13px;color:var(--text-muted)">Uniči skupino sovražnikov</div></div>
        <div style="display:flex;gap:8px;align-items:center"><button id="sp2">Zmaji (300g)</button><div style="font-size:13px;color:var(--text-muted)">Ogenj čez pol zaslona</div></div>
        <div style="display:flex;gap:8px;align-items:center"><button id="sp3">Tornado (400g)</button><div style="font-size:13px;color:var(--text-muted)">Potisne nazaj</div></div>
        <div style="display:flex;gap:8px;align-items:center"><button id="sp4">Air Strike (600g)</button><div style="font-size:13px;color:var(--text-muted)">Masivna škoda</div></div>
        <div style="display:flex;gap:8px;align-items:center"><button id="sp5">Alien Attack (1000g)</button><div style="font-size:13px;color:var(--text-muted)">Velik meteorski dež</div></div>
      </div>
    </div>
  </div>

  <div id="canvasWrap">
    <canvas id="gameCanvas" width="800" height="480"></canvas>
    <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
      <div style="flex:1">
        <div style="font-weight:700; font-size:16px;">Izberi enoto za pošiljanje</div>
        <div id="unitButtons" class="unitsRow" style="margin-top: 8px; display:flex; flex-wrap:wrap; gap:8px;"></div>
      </div>
      <div style="width:260px; border-left: 1px solid var(--panel-border); padding-left: 12px;">
        <div style="font-weight:700; font-size:16px;">Obramba</div>
        <div class="stat"><div>Stolp nivo</div><div id="towerLevel">1</div></div>
        <div class="stat"><div>HP stolpa</div><div id="towerHP">100</div></div>
        <div style="margin-top:8px"><button id="upgradeTower">Nadgradi stolp (100g)</button></div>
      </div>
    </div>
  </div>

  <div id="rightUI">
    <div style="font-weight:700; font-size:16px;">Sovražnikova baza</div>
    <div class="stat"><div>HP</div><div id="enemyBaseHP">1000</div></div>
    <div style="margin-top:16px;color:var(--text-muted);font-size:14px; line-height: 1.6;">Pošlji enote, upravljaj zlato in XP. Cilj: uničiti sovražnikovo bazo in napredovati skozi obdobja.</div>
  </div>
</div>
<footer>Kontrole: klik na gumb enote za pošiljanje. Igra je prototip — če želiš gradnje ali zvoke, povej :)</footer>

<div id="overlay"><div class="box"><div id="overlayText"></div><button id="overlayBtn">Restart</button></div></div>
<div id="toast"></div>

<script>
const ages = [
  { id:0, name:'Kamena doba', goldRate:1, units:[
      {name:'Jamski',cost:10,hp:40,atk:8,spd:0.6,xp:5},
      {name:'Sulica',cost:20,hp:60,atk:14,spd:0.5,xp:8},
      {name:'Dino jezdec',cost:40,hp:120,atk:20,spd:0.9,xp:20}
    ], specialCosts:{meteor:200}},
  { id:1, name:'Srednji vek', goldRate:1.5, units:[
      {name:'Vitez',cost:30,hp:120,atk:18,spd:0.5,xp:14},
      {name:'Lokostrelec',cost:25,hp:60,atk:12,spd:0.7,xp:10},
      {name:'Konjenica',cost:50,hp:160,atk:26,spd:1.0,xp:28}
    ], specialCosts:{dragon:300}},
  { id:2, name:'Renesansa', goldRate:2, units:[
      {name:'Mušketir',cost:40,hp:80,atk:22,spd:0.6,xp:18},
      {name:'Top',cost:70,hp:220,atk:36,spd:0.35,xp:40}
    ], specialCosts:{tornado:400}},
  { id:3, name:'Sodobna doba', goldRate:3, units:[
      {name:'Vojak',cost:30,hp:90,atk:24,spd:0.75,xp:16},
      {name:'Tank',cost:120,hp:420,atk:60,spd:0.3,xp:80}
    ], specialCosts:{airstrike:600}},
  { id:4, name:'Futuristična doba', goldRate:4, units:[
      {name:'Robot',cost:80,hp:200,atk:48,spd:0.7,xp:40},
      {name:'Laser',cost:150,hp:300,atk:90,spd:0.9,xp:120}
    ], specialCosts:{alien:1000}}
];

let state = {
  gold:50, goldFrac:0, xp:0, xpToNext:100, age:0, goldRate:1, towerLevel:1, towerHP:100, enemyBaseHP:1000,
  units:[], enemyUnits:[], projectiles: [],
  time:0, lastGoldTick:0, gameOver:false
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
// ... (ostali elementi ostanejo enaki)
const goldEl = document.getElementById('gold');
const xpEl = document.getElementById('xp');
const xpBar = document.getElementById('xpBar');
const ageLabel = document.getElementById('ageLabel');
const goldRateEl = document.getElementById('goldRate');
const unitButtons = document.getElementById('unitButtons');
const upgradeAgeBtn = document.getElementById('upgradeAge');
const towerLevelEl = document.getElementById('towerLevel');
const towerHPEl = document.getElementById('towerHP');
const upgradeTowerBtn = document.getElementById('upgradeTower');
const enemyBaseHPEl = document.getElementById('enemyBaseHP');
const overlay = document.getElementById('overlay');
const overlayText = document.getElementById('overlayText');
const overlayBtn = document.getElementById('overlayBtn');
const toast = document.getElementById('toast');

// --- Main Game Logic (večina ostane enaka, dodane so nove funkcije) ---

function setupUI(){
  renderUnitButtons();
  updateUI();
}

function renderUnitButtons(){
  unitButtons.innerHTML='';
  const a = ages[state.age];
  a.units.forEach((u,idx)=>{
    const btn = document.createElement('button');
    btn.textContent = `${u.name} — ${u.cost}g`;
    btn.className='small';
    btn.onclick = ()=>{ spawnUnit('player',u); }
    unitButtons.appendChild(btn);
  });
}

function canAfford(cost){ return state.gold >= cost; }

function showToast(text){
  toast.textContent = text;
  toast.style.display = 'block';
  clearTimeout(toast._timer);
  toast._timer = setTimeout(()=>{ toast.style.display = 'none'; }, 1400);
}

function showMessage(text, ended){
  if(ended){ overlayText.textContent = text; overlay.style.display = 'flex'; state.gameOver = true; }
  else showToast(text);
}

upgradeAgeBtn.addEventListener('click', ()=>{
  if(state.age < ages.length-1 && state.xp >= state.xpToNext){
    state.xp -= state.xpToNext;
    state.age++;
    state.goldRate = ages[state.age].goldRate;
    state.xpToNext = Math.max(1, Math.round(state.xpToNext * 1.6));
    renderUnitButtons();
    updateUI();
  }
});

upgradeTowerBtn.addEventListener('click', ()=>{
  const cost = 100 * state.towerLevel;
  if(canAfford(cost)){
    state.gold -= cost;
    state.towerLevel++;
    state.towerHP += 120;
    updateUI();
  } else showToast('Ni dovolj zlata.');
});

// Gumbi za posebne napade ostanejo enaki
document.getElementById('sp1').addEventListener('click', ()=>{ if(canAfford(200)){ state.gold-=200; meteorAttack(); updateUI(); } else showToast('Ni dovolj zlata.'); });
document.getElementById('sp2').addEventListener('click', ()=>{ if(canAfford(300)){ state.gold-=300; dragonAttack(); updateUI(); } else showToast('Ni dovolj zlata.'); });
document.getElementById('sp3').addEventListener('click', ()=>{ if(canAfford(400)){ state.gold-=400; tornadoAttack(); updateUI(); } else showToast('Ni dovolj zlata.'); });
document.getElementById('sp4').addEventListener('click', ()=>{ if(canAfford(600)){ state.gold-=600; airStrike(); updateUI(); } else showToast('Ni dovolj zlata.'); });
document.getElementById('sp5').addEventListener('click', ()=>{ if(canAfford(1000)){ state.gold-=1000; alienAttack(); updateUI(); } else showToast('Ni dovolj zlata.'); });

function spawnUnit(side, template){
  if(side === 'player' && !canAfford(template.cost)) { showToast('Ni dovolj zlata.'); return; }
  if(side === 'player') state.gold -= template.cost;
  const unit = {
    id:Math.random().toString(36).slice(2,9), side, name:template.name, hp:template.hp, maxHp:template.hp,
    atk:template.atk, spd:template.spd, x: side==='player' ? 100 : canvas.width-100, y: 440,
    atkCooldown:0, xpValue: template.xp
  };
  if(side==='player') state.units.push(unit); else state.enemyUnits.push(unit);
  updateUI();
}

let enemySpawnTimer=0;
function enemyAI(dt){
  enemySpawnTimer += dt;
  const cap = 14;
  if(enemySpawnTimer > 2.0){
    enemySpawnTimer = 0;
    if(state.enemyUnits.length < cap){
      const enemyAge = Math.min(state.age, ages.length-1);
      const pool = ages[enemyAge].units;
      const pick = pool[Math.floor(Math.random()*pool.length)];
      spawnUnit('enemy', pick);
    }
  }
}

function meteorAttack(){ state.enemyUnits.forEach(u=>{ if(u.x < canvas.width-200) u.hp -= 80; }); clampEnemyBaseHP(); }
function dragonAttack(){ state.enemyUnits.forEach(u=> u.hp -= 60); clampEnemyBaseHP(); }
function tornadoAttack(){ state.enemyUnits.forEach(u=> u.x += 80); }
function airStrike(){ state.enemyUnits.forEach(u=> u.hp -= 120); state.enemyBaseHP -= 100; clampEnemyBaseHP(); }
function alienAttack(){ state.enemyUnits.forEach(u=> u.hp -= 200); state.enemyBaseHP -= 300; clampEnemyBaseHP(); }

function clampEnemyBaseHP(){ state.enemyBaseHP = Math.max(0, state.enemyBaseHP); }
function clampTowerHP(){ state.towerHP = Math.max(0, state.towerHP); }

function updateUnits(dt){
  state.units.sort((a,b)=> a.x - b.x);
  state.enemyUnits.sort((a,b)=> a.x - b.x);

  for(let i=state.units.length-1;i>=0;i--){
    const u = state.units[i];
    if(u.hp <= 0){ state.xp += u.xpValue; state.units.splice(i,1); continue; }
    let nearest = null; let nd = Infinity;
    for(const e of state.enemyUnits){
      const d = Math.abs(e.x - u.x);
      if(d < nd){ nd = d; nearest = e; }
    }
    if(u.x > canvas.width-100){ state.enemyBaseHP -= u.atk * dt * 5; state.units.splice(i,1); state.xp += u.xpValue; clampEnemyBaseHP(); continue; }
    if(nearest && Math.abs(nearest.x - u.x) < 40){
      if(u.atkCooldown <= 0){ nearest.hp -= u.atk; u.atkCooldown = 1.2; }
    } else { u.x += u.spd * 40 * dt; }
    if(u.atkCooldown>0) u.atkCooldown -= dt;
  }

  for(let i=state.enemyUnits.length-1;i>=0;i--){
    const u = state.enemyUnits[i];
    if(u.hp <= 0){ state.gold += 5; state.enemyUnits.splice(i,1); continue; }
    let nearest = null; let nd = Infinity;
    for(const e of state.units){
      const d = Math.abs(e.x - u.x);
      if(d < nd){ nd = d; nearest = e; }
    }
    if(u.x < 100){ state.towerHP -= u.atk * 1; state.enemyUnits.splice(i,1); clampTowerHP(); continue; }
    if(nearest && Math.abs(nearest.x - u.x) < 40){ if(u.atkCooldown <= 0){ nearest.hp -= u.atk; u.atkCooldown = 1.2; } }
    else { u.x -= u.spd * 40 * dt; }
    if(u.atkCooldown>0) u.atkCooldown -= dt;
  }
}

let towerFireTimer = 0;
function towerAI(dt){
  towerFireTimer += dt;
  const interval = Math.max(0.6, 2.2 - state.towerLevel*0.2);
  if(towerFireTimer > interval && state.enemyUnits.length > 0){
    towerFireTimer = 0;
    let target = state.enemyUnits[0]; // Ciljaj prvega v vrsti
    if(target && target.x < canvas.width * 0.7) { // Ciljaj samo enote, ki so dovolj blizu
      const p = {
        id: Math.random(),
        owner: 'player',
        x: 60, y: 340, // Izhodišče izstrelka
        targetX: target.x, targetY: target.y - 30,
        damage: 30 + state.towerLevel * 10,
        speed: 500,
      };
      state.projectiles.push(p);
    }
  }
}

function updateProjectiles(dt) {
    for (let i = state.projectiles.length - 1; i >= 0; i--) {
        const p = state.projectiles[i];
        const dx = p.targetX - p.x;
        const dy = p.targetY - p.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        
        if (dist < 20) { // Zadetek
            const targetList = p.owner === 'player' ? state.enemyUnits : state.units;
            let hit = false;
            for(const u of targetList) {
                if(Math.abs(u.x - p.targetX) < 25) {
                    u.hp -= p.damage;
                    hit = true;
                    break;
                }
            }
            state.projectiles.splice(i, 1);
            continue;
        }

        p.x += (dx / dist) * p.speed * dt;
        p.y += (dy / dist) * p.speed * dt;
        
        if (p.x < 0 || p.x > canvas.width) { // Izven zaslona
            state.projectiles.splice(i, 1);
        }
    }
}

function cleanupAndLeveling(){ if(state.xp < 0) state.xp = 0; clampTowerHP(); clampEnemyBaseHP(); }

// --- NOVE IN POSODOBLJENE FUNKCIJE ZA RISANJE ---
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // Tla
  const groundGradient = ctx.createLinearGradient(0, 400, 0, canvas.height);
  groundGradient.addColorStop(0, '#44403c');
  groundGradient.addColorStop(1, '#292524');
  ctx.fillStyle = groundGradient;
  ctx.fillRect(0, 400, canvas.width, canvas.height - 400);

  // Risanje stolpov
  drawTower('player');
  drawTower('enemy');

  // Risanje enot
  state.units.forEach(u => drawUnit(u));
  state.enemyUnits.forEach(u => drawUnit(u));

  // Risanje izstrelkov
  drawProjectiles();
}

function drawTower(side) {
    const isPlayer = side === 'player';
    const x = isPlayer ? 20 : canvas.width - 80;
    const color1 = isPlayer ? '#38bdf8' : '#f43f5e';
    const color2 = isPlayer ? '#0ea5e9' : '#e11d48';

    // Osnova
    ctx.fillStyle = color2;
    ctx.fillRect(x, 350, 60, 100);
    
    // Glavni del
    ctx.fillStyle = color1;
    ctx.fillRect(x + 5, 320, 50, 30);

    // Vrh (nazobčan)
    ctx.fillStyle = color2;
    for(let i = 0; i < 4; i++) {
        ctx.fillRect(x + 5 + i * 12, 310, 8, 10);
    }

    // Health Bar
    const hp = isPlayer ? state.towerHP : state.enemyBaseHP;
    const maxHp = isPlayer ? 100 + (state.towerLevel - 1) * 120 : 1000;
    const barX = isPlayer ? x - 10 : x - 70;
    const barWidth = 140;

    ctx.fillStyle = '#1f2937';
    ctx.fillRect(barX, 290, barWidth, 12);
    ctx.fillStyle = isPlayer ? '#4ade80' : '#f43f5e';
    ctx.fillRect(barX, 290, Math.max(0, (hp / maxHp)) * barWidth, 12);
}

function drawUnit(u) {
  const isPlayer = u.side === 'player';
  const yPos = u.y;
  
  // Senca
  ctx.fillStyle = 'rgba(0,0,0,0.2)';
  ctx.beginPath();
  ctx.ellipse(u.x, yPos + 10, 15, 5, 0, 0, Math.PI * 2);
  ctx.fill();

  // Telo
  ctx.fillStyle = isPlayer ? '#38bdf8' : '#f43f5e';
  ctx.fillRect(u.x - 6, yPos - 30, 12, 25);

  // Glava
  ctx.beginPath();
  ctx.arc(u.x, yPos - 40, 8, 0, Math.PI * 2);
  ctx.fill();

  // Orožje (sulica)
  ctx.strokeStyle = '#94a3b8';
  ctx.lineWidth = 3;
  ctx.beginPath();
  const weaponX = isPlayer ? u.x + 5 : u.x - 5;
  const weaponDir = isPlayer ? 1 : -1;
  ctx.moveTo(weaponX, yPos - 25);
  ctx.lineTo(weaponX + 25 * weaponDir, yPos - 45);
  ctx.stroke();

  // Health bar
  ctx.fillStyle = '#111';
  ctx.fillRect(u.x - 18, yPos - 65, 36, 6);
  ctx.fillStyle = '#4ade80';
  ctx.fillRect(u.x - 18, yPos - 65, 36 * Math.max(0, u.hp / u.maxHp), 6);
}

function drawProjectiles() {
    state.projectiles.forEach(p => {
        ctx.save();
        ctx.fillStyle = '#fef08a'; // Rumena barva za puščice
        ctx.shadowColor = '#facc15';
        ctx.shadowBlur = 10;
        
        ctx.beginPath();
        ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
    });
}

// --- Glavna zanka igre ---
let last = performance.now()/1000;
function loop(){
  if(state.gameOver) return;
  const now = performance.now()/1000;
  let dt = now - last;
  if(dt <= 0) dt = 0.016;
  dt = Math.min(0.1, dt);
  last = now;

  // Gold
  state.lastGoldTick += dt;
  if(state.lastGoldTick >= 0.2){
    state.goldFrac += state.goldRate * state.lastGoldTick;
    const add = Math.floor(state.goldFrac);
    if(add > 0){ state.gold += add; state.goldFrac -= add; }
    state.lastGoldTick = 0;
  }
  
  // Posodobitve
  enemyAI(dt);
  updateUnits(dt);
  towerAI(dt);
  updateProjectiles(dt);
  cleanupAndLeveling();
  
  // Risanje
  updateUI();
  draw();

  // Preverjanje konca igre
  if(state.enemyBaseHP <= 0){ showMessage('Zmagal si! Sovražnikova baza je uničena.', true); return; }
  if(state.towerHP <= 0){ showMessage('Izgubil si! Tvoja baza je bila uničena.', true); return; }
  
  requestAnimationFrame(loop);
}

function updateUI(){
  goldEl.textContent = Math.round(state.gold);
  xpEl.textContent = `${Math.round(state.xp)} / ${state.xpToNext}`;
  xpBar.style.width = `${state.xpToNext > 0 ? Math.min(100, (state.xp/state.xpToNext)*100) : 0}%`;
  ageLabel.textContent = ages[state.age].name;
  goldRateEl.textContent = ages[state.age].goldRate;
  towerLevelEl.textContent = state.towerLevel;
  towerHPEl.textContent = Math.round(state.towerHP);
  enemyBaseHPEl.textContent = Math.max(0, Math.round(state.enemyBaseHP));
  
  const canAdvance = state.age < ages.length - 1 && state.xp >= state.xpToNext;
  upgradeAgeBtn.disabled = !canAdvance;
  upgradeAgeBtn.title = canAdvance ? 'Napreduj v naslednje obdobje!' : 'Potrebuješ več XP.';
  
  const cost = 100 * state.towerLevel;
  upgradeTowerBtn.textContent = `Nadgradi stolp (${cost}g)`;
}

function resetGame(){
  state = { gold:50, goldFrac:0, xp:0, xpToNext:100, age:0, goldRate:1, towerLevel:1, towerHP:100, enemyBaseHP:1000, units:[], enemyUnits:[], projectiles:[], time:0, lastGoldTick:0, gameOver:false };
  renderUnitButtons();
  updateUI();
  overlay.style.display='none';
  toast.style.display='none';
  last = performance.now()/1000;
  requestAnimationFrame(loop);
}

overlayBtn.addEventListener('click', ()=>{ resetGame(); });

// Začetne enote
for(let i=0;i<3;i++){ spawnUnit('enemy', ages[0].units[0]); }

// Zagon igre
setupUI();
requestAnimationFrame(loop);
</script>
</body>
</html>